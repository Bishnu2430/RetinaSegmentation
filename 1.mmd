graph LR
    %% Input and Preprocessing
    subgraph Preprocessing["Input & Preprocessing"]
        style Preprocessing fill:#FFF3E0,stroke:#000,stroke-width:3px,color:#000
        direction TB
        Input([Retinal Image])
        Green[Green Channel]
        CLAHE[CLAHE]
        Gamma[Gamma γ=1.2]
        Norm[Normalize]
        Input --> Green --> CLAHE --> Gamma --> Norm
    end
    
    %% Encoder Path
    subgraph Encoder["Encoder Path"]
        style Encoder fill:#E8F5E9,stroke:#000,stroke-width:3px,color:#000
        direction TB
        E1[E1: 1→32<br/>H/2×W/2]
        E2[E2: 32→64<br/>H/4×W/4]
        E3[E3: 64→128<br/>H/8×W/8]
        E1 --> E2 --> E3
    end
    
    %% Bottleneck
    subgraph Bottleneck["Bottleneck"]
        style Bottleneck fill:#FFFDE7,stroke:#000,stroke-width:3px,color:#000
        direction TB
        BN1[Conv 128→256]
        ODE[Neural ODE]
        RK4[RK4 Solver]
        BN1 --> ODE --> RK4
    end
    
    %% Decoder Path
    subgraph Decoder["Decoder Path"]
        style Decoder fill:#E0F2F1,stroke:#000,stroke-width:3px,color:#000
        direction TB
        D3[D3: Up 256→128]
        D2[D2: Up 128→64]
        D1[D1: Up 64→32]
        D3 --> D2 --> D1
    end
    
    %% Output
    subgraph Output["Output"]
        style Output fill:#F3E5F5,stroke:#000,stroke-width:3px,color:#000
        direction TB
        OutLayer[Conv 1×1<br/>32→1]
        Sigmoid[Sigmoid]
        OutLayer --> Sigmoid
    end
    
    %% Result
    subgraph Result["Result"]
        style Result fill:#E1F5FE,stroke:#000,stroke-width:3px,color:#000
        direction TB
        PredMask([Predicted<br/>Mask])
    end
    
    %% Loss
    subgraph Loss["Loss Computation"]
        style Loss fill:#FCE4EC,stroke:#000,stroke-width:3px,color:#000
        direction TB
        GTMask([Ground Truth<br/>Mask])
        BCE[BCE Loss]
        DiceLoss[Dice Loss]
        SkelLoss[Skeleton Loss]
        CombLoss[Combined Loss<br/>0.4·BCE+0.4·Dice<br/>+0.2·Skeleton]
        Update([Model<br/>Update])
        BCE & DiceLoss & SkelLoss --> CombLoss --> Update
    end
    
    %% Main Flow
    Preprocessing --> Encoder
    Encoder --> Bottleneck
    Bottleneck --> Decoder
    Decoder --> Output
    Output --> Result
    Result --> Loss
    
    %% Skip Connections
    E3 -.->|skip| D3
    E2 -.->|skip| D2
    E1 -.->|skip| D1
    
    %% Loss connections
    PredMask --> BCE
    PredMask --> DiceLoss
    PredMask --> SkelLoss
    GTMask --> BCE
    GTMask --> DiceLoss
    GTMask --> SkelLoss
    
    %% Styling
    classDef inputNode fill:#E3F2FD,stroke:#000,stroke-width:2px,color:#000
    classDef preprocessNode fill:#FFE0B2,stroke:#000,stroke-width:2px,color:#000
    classDef encoderNode fill:#C8E6C9,stroke:#000,stroke-width:2px,color:#000
    classDef bottleneckNode fill:#FFF9C4,stroke:#000,stroke-width:2px,color:#000
    classDef decoderNode fill:#B2DFDB,stroke:#000,stroke-width:2px,color:#000
    classDef outputNode fill:#D1C4E9,stroke:#000,stroke-width:2px,color:#000
    classDef resultNode fill:#BBDEFB,stroke:#000,stroke-width:2px,color:#000
    classDef lossNode fill:#FFCCBC,stroke:#000,stroke-width:2px,color:#000
    classDef updateNode fill:#C5E1A5,stroke:#000,stroke-width:2px,color:#000
    
    class Input inputNode
    class Green,CLAHE,Gamma,Norm preprocessNode
    class E1,E2,E3 encoderNode
    class BN1,ODE,RK4 bottleneckNode
    class D3,D2,D1 decoderNode
    class OutLayer,Sigmoid outputNode
    class PredMask,GTMask resultNode
    class BCE,DiceLoss,SkelLoss,CombLoss lossNode
    class Update updateNode
    
    linkStyle default stroke:#000,stroke-width:2px